"use strict";(self.webpackChunkdocusaurus_code=self.webpackChunkdocusaurus_code||[]).push([[6064],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>d});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),m=c(n),d=r,g=m["".concat(s,".").concat(d)]||m[d]||u[d]||o;return n?a.createElement(g,i(i({ref:t},p),{},{components:n})):a.createElement(g,i({ref:t},p))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},85162:(e,t,n)=>{n.d(t,{Z:()=>i});var a=n(67294),r=n(34334);const o="tabItem_Ymn6";function i(e){let{children:t,hidden:n,className:i}=e;return a.createElement("div",{role:"tabpanel",className:(0,r.Z)(o,i),hidden:n},t)}},65488:(e,t,n)=>{n.d(t,{Z:()=>d});var a=n(83117),r=n(67294),o=n(34334),i=n(72389),l=n(67392),s=n(7094),c=n(12466);const p="tabList__CuJ",u="tabItem_LNqP";function m(e){var t;const{lazy:n,block:i,defaultValue:m,values:d,groupId:g,className:k}=e,b=r.Children.map(e.children,(e=>{if((0,r.isValidElement)(e)&&"value"in e.props)return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})),h=d??b.map((e=>{let{props:{value:t,label:n,attributes:a}}=e;return{value:t,label:n,attributes:a}})),f=(0,l.l)(h,((e,t)=>e.value===t.value));if(f.length>0)throw new Error(`Docusaurus error: Duplicate values "${f.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`);const v=null===m?m:m??(null==(t=b.find((e=>e.props.default)))?void 0:t.props.value)??b[0].props.value;if(null!==v&&!h.some((e=>e.value===v)))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${v}" but none of its children has the corresponding value. Available values are: ${h.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);const{tabGroupChoices:y,setTabGroupChoices:N}=(0,s.U)(),[x,C]=(0,r.useState)(v),S=[],{blockElementScrollPositionUntilNextRender:T}=(0,c.o5)();if(null!=g){const e=y[g];null!=e&&e!==x&&h.some((t=>t.value===e))&&C(e)}const w=e=>{const t=e.currentTarget,n=S.indexOf(t),a=h[n].value;a!==x&&(T(t),C(a),null!=g&&N(g,String(a)))},E=e=>{var t;let n=null;switch(e.key){case"ArrowRight":{const t=S.indexOf(e.currentTarget)+1;n=S[t]??S[0];break}case"ArrowLeft":{const t=S.indexOf(e.currentTarget)-1;n=S[t]??S[S.length-1];break}}null==(t=n)||t.focus()};return r.createElement("div",{className:(0,o.Z)("tabs-container",p)},r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.Z)("tabs",{"tabs--block":i},k)},h.map((e=>{let{value:t,label:n,attributes:i}=e;return r.createElement("li",(0,a.Z)({role:"tab",tabIndex:x===t?0:-1,"aria-selected":x===t,key:t,ref:e=>S.push(e),onKeyDown:E,onFocus:w,onClick:w},i,{className:(0,o.Z)("tabs__item",u,null==i?void 0:i.className,{"tabs__item--active":x===t})}),n??t)}))),n?(0,r.cloneElement)(b.filter((e=>e.props.value===x))[0],{className:"margin-top--md"}):r.createElement("div",{className:"margin-top--md"},b.map(((e,t)=>(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==x})))))}function d(e){const t=(0,i.Z)();return r.createElement(m,(0,a.Z)({key:String(t)},e))}},32102:(e,t,n)=>{n.d(t,{s:()=>k});var a=n(83117),r=n(67294),o=n(42293),i=n(50657),l=n(6514),s=n(54776),c=n(10155),p=n(15861),u=n(93946),m=n(9137),d=n(61274),g=n(50594);const k=(0,r.memo)((e=>{let{open:t,fullScreen:n=!1,title:a,maxWidth:s="md",onClose:k,children:h}=e;const[f,v]=(0,r.useState)(n),y=(0,r.useCallback)((()=>{v((e=>!e))}),[]);return r.createElement(i.Z,{open:t,onClose:k,fullScreen:f,TransitionComponent:b,maxWidth:s},r.createElement(o.Z,{sx:{position:"relative"}},r.createElement(c.Z,null,r.createElement(p.Z,{sx:{ml:2,flex:1},variant:"h6",component:"div"},a),r.createElement(u.Z,{onClick:y,style:{color:"white"}},f?r.createElement(d.Z,null):r.createElement(m.Z,null)),r.createElement(u.Z,{"aria-label":"close",onClick:k,style:{color:"white"}},r.createElement(g.Z,null)))),r.createElement(l.Z,null,h))})),b=r.forwardRef((function(e,t){return r.createElement(s.Z,(0,a.Z)({direction:"up",ref:t},e))}))},39511:(e,t,n)=>{n.d(t,{b:()=>i});var a=n(67294),r=n(83321),o=n(32102);const i=(0,a.memo)((e=>{let{buttonText:t,fullScreen:n=!1,title:i=t,variant:l="outlined",maxWidth:s,useOriginalText:c=!0,children:p}=e;const[u,m]=(0,a.useState)(!1),d=(0,a.useCallback)((e=>{m(!0),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}),[]),g=(0,a.useCallback)((()=>{m(!1)}),[]),k=c?{textTransform:"none"}:{};return a.createElement(a.Fragment,null,a.createElement(r.Z,{"data-is-view-more-button":"true",onClick:d,variant:l,size:"small",style:k},t),a.createElement(o.s,{open:u,onClose:g,title:i,maxWidth:s,fullScreen:n},p))}))},80672:(e,t,n)=>{n.d(t,{ZP:()=>s});var a=n(83117),r=(n(67294),n(3905)),o=n(65488),i=n(85162);const l={toc:[]};function s(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},l,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"In Jimmer, all executable statements and instructions support two execution modes:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Execute based on the JDBC connection specified by the user  ")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Executed by Jimmer automatically determining based on a JDBC connection"))),(0,r.kt)("p",null,"Here, take ",(0,r.kt)("inlineCode",{parentName:"p"},"Executable")," (Java) or ",(0,r.kt)("inlineCode",{parentName:"p"},"KExecutable")," (Kotlin) interface as an example"),(0,r.kt)(o.Z,{groupId:"language",mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"java",label:"Java",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="Executable.java"',title:'"Executable.java"'},"package org.babyfish.jimmer.sql.ast;\n\nimport java.sql.Connection;\n\npublic interface Executable<R> {\n\n    R execute();\n\n    R execute(Connection con);\n}\n"))),(0,r.kt)(i.Z,{value:"kotlin",label:"Kotlin",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-kotlin",metastring:'title="KExecutable.kt"',title:'"KExecutable.kt"'},"package org.babyfish.jimmer.sql.kt\n\nimport java.sql.Connection  \n\ninterface KExecutable<R> {\n  fun execute(con: Connection? = null): R\n}\n")))),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"execute(Connection)"),": Execute on the JDBC connection specified by the user."),(0,r.kt)("p",{parentName:"li"},"Take query as an example:"),(0,r.kt)(o.Z,{groupId:"language",mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"java",label:"Java",mdxType:"TabItem"},(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-java"},"BookTable book = Tables.BOOK_TABLE;\n\nList<Book> books = sqlClient\n    .createQuery(book)\n    .select(book)\n    // highlight-next-line\n    .execute(con);\n"))),(0,r.kt)(i.Z,{value:"kotlin",label:"Kotlin",mdxType:"TabItem"},(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-kotlin"},"val books = sqlClient\n    .createQuery(Book::class) {\n        select(table)\n    }\n    // highlight-next-line\n    .execute(con)\n")))),(0,r.kt)("admonition",{parentName:"li",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"For this usage, no special configuration of SqlClient is required."))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"execute()")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"execute(null)"),": Determined by Jimmer to execute on a JDBC connection."),(0,r.kt)("p",{parentName:"li"},"Take query as an example:"),(0,r.kt)(o.Z,{groupId:"language",mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"java",label:"Java",mdxType:"TabItem"},(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-java"},"BookTable book = Tables.BOOK_TABLE;\n\nList<Book> books = sqlClient\n    .createQuery(book)\n    .select(book)\n    // highlight-next-line  \n    .execute();\n"))),(0,r.kt)(i.Z,{value:"kotlin",label:"Kotlin",mdxType:"TabItem"},(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-kotlin"},"val books = sqlClient\n    .createQuery(Book::class) {\n        select(table)\n    }\n    // highlight-next-line\n    .execute()\n")))),(0,r.kt)("admonition",{parentName:"li",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"For this usage, ",(0,r.kt)("inlineCode",{parentName:"p"},"ConnectionManager")," must be configured for SqlClient. Otherwise it will cause exceptions."),(0,r.kt)("p",{parentName:"admonition"},"Undoubtedly, the 2nd approach is more in line with the requirements of business system development, so it is recommended. So it is strongly recommended to configure ",(0,r.kt)("inlineCode",{parentName:"p"},"ConnectionManager")," for SqlClient.")))))}s.isMDXComponent=!0},27409:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>m,contentTitle:()=>p,default:()=>k,frontMatter:()=>c,metadata:()=>u,toc:()=>d});var a=n(83117),r=(n(67294),n(3905)),o=n(65488),i=n(85162),l=n(39511),s=n(80672);const c={sidebar_position:1,title:"Spring Transaction"},p=void 0,u={unversionedId:"spring/transaction",id:"spring/transaction",title:"Spring Transaction",description:"Integrate Spring Transaction",source:"@site/docs/spring/transaction.mdx",sourceDirName:"spring",slug:"/spring/transaction",permalink:"/jimmer-doc/docs/spring/transaction",draft:!1,editUrl:"https://github.com/babyfish-ct/jimmer-doc/edit/main/docs/spring/transaction.mdx",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,title:"Spring Transaction"},sidebar:"tutorialSidebar",previous:{title:"Spring",permalink:"/jimmer-doc/docs/spring/"},next:{title:"Spring Data",permalink:"/jimmer-doc/docs/spring/repository/"}},m={},d=[{value:"Integrate Spring Transaction",id:"integrate-spring-transaction",level:2},{value:"Using Spring Boot starter",id:"using-spring-boot-starter",level:3},{value:"Not Using Spring Boot Starter",id:"not-using-spring-boot-starter",level:3},{value:"Work with JdbcTemplate",id:"work-with-jdbctemplate",level:2},{value:"Multiple Data Sources",id:"multiple-data-sources",level:2}],g={toc:d};function k(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},g,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"integrate-spring-transaction"},"Integrate Spring Transaction"),(0,r.kt)("p",null,"In Jimmer, all database operation APIs have two execution modes:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Execute on a specified JDBC connection")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Execute without specifying a JDBC connection, but a ",(0,r.kt)("inlineCode",{parentName:"p"},"ConnectionManager")," needs to be configured for Jimmer to teach Jimmer how to borrow and return connections. "))),(0,r.kt)("p",null,"Please refer to ",(0,r.kt)(l.b,{buttonText:"here",title:"Two execution ways",mdxType:"ViewMore"}," ",(0,r.kt)(s.ZP,{mdxType:"Execute"}))," for more details."),(0,r.kt)("p",null,"So Jimmer itself does not provide connection/transaction management capabilities, such management capabilities completely rely on user customization of ",(0,r.kt)("inlineCode",{parentName:"p"},"ConnectionManager"),". ",(0,r.kt)("inlineCode",{parentName:"p"},"ConnectionManager")," is the key to integrate Jimmer with the connection/transaction management capabilities of any IOC framework ",(0,r.kt)("em",{parentName:"p"},"(of course including Spring)"),"."),(0,r.kt)("h3",{id:"using-spring-boot-starter"},"Using Spring Boot starter"),(0,r.kt)("p",null,"If using the Spring Boot Starter provided by Jimmer, no extra work is needed. Jimmer will automatically integrate into Spring's transaction management mechanism."),(0,r.kt)("h3",{id:"not-using-spring-boot-starter"},"Not Using Spring Boot Starter"),(0,r.kt)("p",null,"If using Spring only, without the Spring Boot Starter provided by Jimmer.\nYou need to code by yourself to integrate Jimmer into Spring's transaction management mechanism."),(0,r.kt)("p",null,"Developers need to create ",(0,r.kt)("inlineCode",{parentName:"p"},"JSqlClient/KSqlClient")," and set its ",(0,r.kt)("inlineCode",{parentName:"p"},"ConnectionManager"),". In ",(0,r.kt)("inlineCode",{parentName:"p"},"ConnectionManager"),", use Spring's ",(0,r.kt)("inlineCode",{parentName:"p"},"org.springframework.jdbc.datasource.DataSourceUtils")," to open and close connections."),(0,r.kt)(o.Z,{groupId:"language",mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"java",label:"Java",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="Book.java"',title:'"Book.java"'},"@Bean  \npublic JSqlClient sqlClient(DataSource dataSource) {\n    return JSqlClient.newBuilder()\n        // highlight-next-line  \n        .setConnectionManager(\n            new ConnectionManager() {\n                @Override\n                public <R> R execute(\n                    Function<Connection, R> block\n                ) {\n                    Connection con = DataSourceUtils\n                        // highlight-next-line\n                        .getConnection(dataSource);\n                    try {\n                        return block.apply(con);\n                    } finally {\n                        DataSourceUtils\n                        // highlight-next-line\n                        .releaseConnection(con, dataSource);\n                    }\n                }\n            }\n        )\n        ...Omit other configurations...\n        .build();\n}\n"))),(0,r.kt)(i.Z,{value:"kotlin",label:"Kotlin",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-kotlin",metastring:'title="Book.kt"',title:'"Book.kt"'},"@Bean\nfun sqlClient(dataSource: DataSource): KSqlClient = \n    newKSqlClient {\n        // highlight-next-line\n        setConnectionManager {\n            val con = DataSourceUtils\n                // highlight-next-line\n                .getConnection(dataSource)\n            try {\n                proceed(con)  \n            } finally {\n                DataSourceUtils\n                // highlight-next-line\n                .releaseConnection(con, dataSource)\n            }\n        }\n        ...Omit other configurations...\n    }\n")))),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Don't use normal methods to borrow ",(0,r.kt)("em",{parentName:"p"},"(dataSource.getConnection)")," and return ",(0,r.kt)("em",{parentName:"p"},"(con.close)")," connections from the connection pool.\nYou must use Spring's ",(0,r.kt)("inlineCode",{parentName:"p"},"org.springframework.jdbc.datasource.DataSourceUtils"),",\nbecause this can be combined with Spring's transaction management mechanism.")),(0,r.kt)("h2",{id:"work-with-jdbctemplate"},"Work with JdbcTemplate"),(0,r.kt)("p",null,"Jimmer adopts minimalist design. The API entry point ",(0,r.kt)("inlineCode",{parentName:"p"},"JSqlClient/KSqlClient")," exposes stateless APIs."),(0,r.kt)("p",null,"Many database operation frameworks provide lightweight stateful wrappers for JDBC connections, such as"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"JPA's ",(0,r.kt)("a",{parentName:"li",href:"https://docs.oracle.com/javaee/7/api/javax/persistence/EntityManager.html"},"EntityManager")),(0,r.kt)("li",{parentName:"ul"},"Hibernate's ",(0,r.kt)("a",{parentName:"li",href:"https://docs.jboss.org/hibernate/orm/6.2/javadocs/org/hibernate/Session.html"},"Session")," "),(0,r.kt)("li",{parentName:"ul"},"MyBatis's ",(0,r.kt)("a",{parentName:"li",href:"https://javadoc.io/doc/org.mybatis/mybatis/latest/org/apache/ibatis/session/SqlSession.html"},"SqlSession"),".")),(0,r.kt)("p",null,"And they also provide stateful wrappers for database transactions, such as"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"JPA's ",(0,r.kt)("a",{parentName:"li",href:"https://docs.oracle.com/javaee/7/api/javax/persistence/EntityManager.html#getTransaction--"},"EntityManager.getTransaction()")),(0,r.kt)("li",{parentName:"ul"},"Hibernate's ",(0,r.kt)("a",{parentName:"li",href:"https://docs.jboss.org/hibernate/orm/6.2/javadocs/org/hibernate/SharedSessionContract.html#getTransaction()"},"Session.getTransaction()")),(0,r.kt)("li",{parentName:"ul"},"MyBatis's ",(0,r.kt)("a",{parentName:"li",href:"https://javadoc.io/doc/org.mybatis/mybatis/latest/org/apache/ibatis/session/SqlSession.html#commit()"},"SqlSession.commit()"))),(0,r.kt)("p",null,"Jimmer doesn't have similar abstractions. The API entry point ",(0,r.kt)("inlineCode",{parentName:"p"},"JSqlClient/KSqlClient")," exposes stateless APIs. JDBC connection is the only low-level dependency of Jimmer.  "),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"This enables an important feature: Jimmer's transaction management is exactly the same as JdbcTemplate's transaction management.")),(0,r.kt)("p",null,"Jimmer doesn't need to provide any APIs like ",(0,r.kt)("inlineCode",{parentName:"p"},"createNativeQuery")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"For report queries that are not closely related to ORM, users expect to write complete Native SQL, then JdbcTemplate can be used directly, because Jimmer's transaction management is exactly the same as JdbcTemplate's.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"For Jimmer's ORM-style queries, inject ",(0,r.kt)("a",{parentName:"p",href:"../query/native-sql"},"Native SQL")," expressions in strongly typed SQL DSL."))),(0,r.kt)("h2",{id:"multiple-data-sources"},"Multiple Data Sources"),(0,r.kt)("p",null,"In the previous sections, we discussed the integration of Spring transactions in the single data source scenario.\nAs for multiple data sources, please refer to ",(0,r.kt)("a",{parentName:"p",href:"../configuration/multi-datasources"},"this section"),"."))}k.isMDXComponent=!0}}]);