---
sidebar_position: 5
title: ğŸ”¥ éšå¼å­æŸ¥è¯¢
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

é›†åˆ *(ä¸€å¯¹å¤šæˆ–å¤šå¯¹å¤š)* å…³è”å¾€å¾€å¯¼è‡´éœ€è¦åœ¨æŸ¥è¯¢ä¸­é«˜é¢‘ä½¿ç”¨å­æŸ¥è¯¢ï¼Œéšå¼å­æŸ¥è¯¢å¯¹è¿™ç±»å­æŸ¥è¯¢ç»™äºˆäº†æå¤§çš„ç®€åŒ–ã€‚

> è‡³äºå®Œæ•´çš„æ™®é€šå­æŸ¥è¯¢ï¼Œè¯·å‚è§[æ™®é€šå­æŸ¥è¯¢](./sub-query)

## Jimmerä¸ºé›†åˆå…³è”ç”ŸæˆDSLçš„ä»£ç 

ä»¥å¤šå¯¹å¤šå…³è”`Book.authors`ä¸ºä¾‹ï¼Œç»è¿‡ç¼–è¯‘ï¼ŒJimmerä¼šç”Ÿæˆå¦‚ä¸‹ä»£ç 

<Tabs groupId="language">
<TabItem value="java" label="Java">

```java title="BookTable.java"
@GeneratedBy(type = Book.class)
public class BookTable extends AbstractTypedTable<Book> implements BookProps {

    @Override
    // highlight-next-line
    public Predicate authors(Function<AuthorTableEx, Predicate> block) {
        ...çœç•¥å®ç°é€»è¾‘...
    }
}
```

</TabItem>
<TabItem value="kotlin" label="Kotlin">

```kotlin
// highlight-next-line
fun KProps<Book>.authors(
    block: KNonNullTableEx<Author>.() -> KNonNullExpression<Boolean>?
): KNonNullExpression<Boolean>? = ...çœç•¥å®ç°é€»è¾‘...
```

</TabItem>
</Tabs>

ç”¨æˆ·å¯ä»¥åŸºäºæ­¤`authors`æ–¹æ³•æ„å»ºéšå«å­æŸ¥è¯¢ã€‚

æ­¤æ–¹æ³•çš„å‚æ•°æ˜¯lambdaè¡¨è¾¾å¼ï¼Œå…¶å‚æ•°ä¸ºå…³è”å¯¹è±¡çš„è¡¨å¯¹è±¡ï¼Œç”¨æˆ·è¿”å›ä¸€ä¸ªè¿‡æ»¤æ­¤å…³è”å¯¹è±¡çš„SQLæ¡ä»¶å³å¯ã€‚

## ç¤ºèŒƒ

<Tabs groupId="language">
<TabItem value="java" label="Java">

```java
BookTable table = Tables.BOOK_TABLE;

public List<Book> findBooks(@Nullable String authorName) {
    return sqlClient
        .createQuery(table)
        .whereIf(
                authorName != null && !authorName.isEmpty(),
                // highlight-next-line
                table.authors(author -> {
                    return Predicate.or(
                            author.firstName().ilike(authorName),
                            author.lastName().ilike(authorName)
                    );
                })
        )
        .select(table)
        .execute();
}
```

</TabItem>
<TabItem value="kotlin" label="Kotlin">

```kotlin
fun findBooks(authorName: String?): List<BookStore> =
    sqlClient.createQuery(Book::class) {
        authorName?.takeIf { it.isNotEmpty() }?.let {
            // highlight-next-line
            where += table.authors {
                or(
                    firstName ilike it,
                    lastName ilike it
                )
            }
        }
    }.execute()
```

</TabItem>
</Tabs>

è°ƒç”¨ä¸Šé¢çš„æ–¹æ³•ï¼Œå¹¶æŒ‡å®šå‚æ•°ä¸ºénullï¼Œæ¯”å¦‚`findBooks("alex")`ï¼Œç”Ÿæˆçš„SQLå¦‚ä¸‹

```sql
select
    tb_1_.ID,
    tb_1_.CREATED_TIME,
    tb_1_.MODIFIED_TIME,
    tb_1_.TENANT,
    tb_1_.NAME,
    tb_1_.EDITION,
    tb_1_.PRICE,
    tb_1_.STORE_ID
from BOOK tb_1_
where
    exists( âŠ
        select
            1
        from AUTHOR tb_2_
        inner join BOOK_AUTHOR_MAPPING tb_3_
            on tb_2_.ID = tb_3_.AUTHOR_ID
        where
                tb_3_.BOOK_ID = tb_1_.ID â‹
            and
                (
                    lower(tb_2_.FIRST_NAME) like ? /* %alex% */ âŒ
                or
                    lower(tb_2_.LAST_NAME) like ? /* %alex% */ â
                )
    )
```

-   âŠ éšå«å­æŸ¥è¯¢æ€»æ˜¯é‡‡ç”¨`exists`

-   â‹ Jimmmerè‡ªåŠ¨ç”Ÿæˆçš„SQLæ¡ä»¶ï¼Œç”¨äºå…³è”çˆ¶å­æŸ¥è¯¢

-   âŒ â ç”¨æˆ·æŒ‡å®šçš„æ¡ä»¶ï¼Œç”¨äºè¿‡æ»¤å…³è”å¯¹è±¡

:::tip
çˆ¶å­æŸ¥è¯¢çš„å…³è”æ¡ä»¶è¢«è‡ªåŠ¨ç”Ÿæˆï¼Œç”¨æˆ·åªéœ€è¦æŒ‡å®šå…³è”å¯¹è±¡è¿‡æ»¤æ¡ä»¶ï¼Œè¿™æ˜¯éšå«å­æŸ¥è¯¢å’Œ[æ™®é€šå­æŸ¥è¯¢](./sub-query)çš„æœ¬è´¨åŒºåˆ«ã€‚
:::

## è‡ªåŠ¨åˆå¹¶

å’Œ[åŠ¨æ€JOINçš„è‡ªåŠ¨åˆå¹¶](dynamic-join/merge)ç±»ä¼¼ï¼Œé’ˆå¯¹ç›¸åŒå…³è”å¤šä¸ªéšå«å­æŸ¥è¯¢ä¹Ÿå¯ä»¥è¢«è‡ªåŠ¨åˆå¹¶ã€‚

:::caution
éšå«å­æŸ¥è¯¢çš„åˆå¹¶è§„åˆ™å¹¶æ²¡æœ‰åŠ¨æ€JOINé‚£ä¹ˆé€šç”¨ï¼Œä»…é™äºåŒä¸€ä¸ªand, oræˆ–notå†…éƒ¨
:::

ä¾‹å¦‚

<Tabs groupId="language">
<TabItem value="java" label="Java">

```java
BookTable table = Tables.BOOK_TABLE;

public List<Book> findBooks(
    @Nullable String authorName, 
    @Nullable Gender authorGender
) {
    return sqlClient
        .createQuery(table)
        .whereIf(
            authorName != null && !authorName.isEmpty(),
            // highlight-next-line
            table.authors(author -> {
                return Predicate.or(
                        author.firstName().ilike(authorName),
                        author.lastName().ilike(authorName)
                );
            })
        )
        .whereIf(
            authorGender != null,
            // highlight-next-line
            table.authors(author -> author.gender().eq(authorGender))
        )
        .select(table)
        .execute();
}
```

</TabItem>
<TabItem value="kotlin" label="Kotlin">

```kotlin
fun findBooks(authorName: String?): List<BookStore> =
    sqlClient.createQuery(Book::class) {
        authorName?.takeIf { it.isNotEmpty() }?.let {
            // highlight-next-line
            where += table.authors {
                or(
                    firstName ilike it,
                    lastName ilike it
                )
            }
        }
        authorGender?.let {
            // highlight-next-line
            where += table.authors {
                gender like it
            }
        }
    }.execute()
```

</TabItem>
</Tabs>

ä¸Šé¢çš„ä¾‹å­é‡‡ç”¨äº†ä¸¤ä¸ªéšå«å­æŸ¥è¯¢ã€‚

ç„¶è€Œï¼Œå½“æˆ‘ä»¬æŠŠä¸¤ä¸ªå‚æ•°éƒ½æŒ‡å®šæˆénullæ—¶ï¼Œæ¯”å¦‚*findBooks("alex", Gender.MALE)`ï¼Œ*æœ€ç»ˆSQLä¸­åªä¼šå‡ºç°ä¸€ä¸ªå­æŸ¥è¯¢ï¼Œå¦‚ä¸‹

```sql
select
    tb_1_.ID,
    tb_1_.CREATED_TIME,
    tb_1_.MODIFIED_TIME,
    tb_1_.TENANT,
    tb_1_.NAME,
    tb_1_.EDITION,
    tb_1_.PRICE,
    tb_1_.STORE_ID
from BOOK tb_1_
where
    // Merge two implicit subqueries to one real sub query
    // highlight-next-line
    exists(
        select
            1
        from AUTHOR tb_2_
        inner join BOOK_AUTHOR_MAPPING tb_3_
            on tb_2_.ID = tb_3_.AUTHOR_ID
        where
                tb_3_.BOOK_ID = tb_1_.ID
            and
                (
                    lower(tb_2_.FIRST_NAME) like ? /* %alex% */
                or
                    lower(tb_2_.LAST_NAME) like ? /* %alex% */
                )
            and
                tb_2_.GENDER = ? /* M */
    )
```

è¿™æ˜¯å› ä¸ºåŒä¸€ä¸ªand, oræˆ–notå†…éƒ¨ï¼Œé’ˆå¯¹ç›¸åŒå…³è”çš„å¤šä¸ªéšå¼å­æŸ¥è¯¢ä¼šè¢«è‡ªåŠ¨åˆå¹¶ã€‚
